<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusComs - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/nexus-logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #FFFFFF;
        }

        /* ===== LOGIN PAGE ===== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 20px;
        }

        .login-card {
            background: #2a2a2a;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 100%;
            padding: 40px;
            border: 1px solid #404040;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #D4AF37;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
        }

        .login-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #FFFFFF;
        }

        .login-header p {
            color: #b0b0b0;
            font-size: 14px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: #1a1a1a;
            border: 2px solid #404040;
            border-radius: 8px;
            font-size: 14px;
            color: #FFFFFF;
            transition: border-color 0.3s;
        }

        input::placeholder {
            color: #808080;
        }

        input:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        button {
            width: 100%;
            padding: 12px 24px;
            background: #D4AF37;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #E8D5A8;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            border-left: 4px solid #FF6B6B;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: none;
            font-size: 14px;
        }

        /* ===== DASHBOARD PAGE ===== */
        .dashboard {
            display: none;
        }

        .header {
            background: #2a2a2a;
            padding: 20px 40px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #FFFFFF;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #FFFFFF;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #D4AF37;
            color: #1a1a1a;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #E8D5A8;
        }

        .content {
            padding: 40px;
            background: #1a1a1a;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .add-user-btn {
            padding: 10px 20px;
            background: #D4AF37;
            color: #1a1a1a;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-user-btn:hover {
            background: #E8D5A8;
        }

        .search-box {
            padding: 10px 16px;
            background: #1a1a1a;
            border: 2px solid #404040;
            border-radius: 6px;
            width: 250px;
            color: #FFFFFF;
        }

        .search-box::placeholder {
            color: #808080;
        }

        /* ===== USER TABLE ===== */
        .table-container {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #404040;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #3a3a3a;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #404040;
            font-size: 14px;
            color: #FFFFFF;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #404040;
            font-size: 14px;
            color: #FFFFFF;
        }

        tr:hover {
            background: #3a3a3a;
            cursor: pointer;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .edit-btn {
            background: #D4AF37;
            color: #1a1a1a;
        }

        .edit-btn:hover {
            background: #E8D5A8;
        }

        .delete-btn {
            background: #FF6B6B;
            color: white;
        }

        .delete-btn:hover {
            background: #FF5252;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #404040;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #FFFFFF;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #b0b0b0;
        }

        .close-btn:hover {
            color: #FFFFFF;
        }

        .modal-body {
            padding: 24px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #404040;
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #808080;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab.active {
            color: #D4AF37;
            border-bottom-color: #D4AF37;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: normal;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #404040;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-cancel, .btn-save {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: #404040;
            color: #FFFFFF;
        }

        .btn-cancel:hover {
            background: #505050;
        }

        .btn-save {
            background: #D4AF37;
            color: #1a1a1a;
        }

        .btn-save:hover {
            background: #E8D5A8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #808080;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.enabled {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .status-badge.disabled {
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
        }

        /* ===== SIDEBAR NAVIGATION ===== */
        .dashboard-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: #2a2a2a;
            border-right: 1px solid #404040;
            padding: 30px 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid #404040;
            margin-bottom: 20px;
        }

        .sidebar-header h3 {
            font-size: 14px;
            color: #b0b0b0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .nav-item {
            padding: 12px 20px;
            color: #b0b0b0;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }

        .nav-item.active {
            background: rgba(212, 175, 55, 0.15);
            color: #D4AF37;
            border-left-color: #D4AF37;
        }

        .dashboard-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .section {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .section.active {
            display: flex;
        }

        .section-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: #1a1a1a;
        }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <img src="/nexus-logo.png" alt="NexusComs Logo">
                </div>
                <h1>NexusComs</h1>
                <p>Admin Dashboard</p>
            </div>
            
            <div class="error-message" id="loginError"></div>
            
            <form id="loginForm">
                <!-- Step 1: Email entry -->
                <div id="step1">
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required placeholder="admin@example.com">
                    </div>
                    <button type="button" id="sendCodeBtn" onclick="sendVerificationCode()">Send Code</button>
                </div>

                <!-- Step 2: Code entry -->
                <div id="step2" style="display: none;">
                    <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 16px;">
                        A verification code has been sent to your email. It expires in 10 minutes.
                    </p>
                    <div class="form-group">
                        <label for="code">Verification Code</label>
                        <input type="text" id="code" placeholder="000000" maxlength="6" inputmode="numeric" required>
                    </div>
                    <button type="button" id="verifyCodeBtn" onclick="verifyCode()">Verify & Sign In</button>
                    <button type="button" style="background: #404040; color: #FFFFFF; margin-top: 8px;" onclick="goBackToEmail()">Back</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div class="header-logo">
                <img src="/nexus-logo.png" alt="NexusComs Logo">
                <h1>NexusComs Admin</h1>
            </div>
            <div class="user-info">
                <span id="currentUser"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="dashboard-wrapper">
            <!-- SIDEBAR NAVIGATION -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>Management</h3>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-item active" onclick="switchSection('dashboard-section')">Dashboard</div>
                    <div class="nav-item" onclick="switchSection('logs-section')">Logs</div>
                    <div class="nav-item" onclick="switchSection('users')">Users</div>
                    <div class="nav-item" onclick="switchSection('billing-plans')">Billing Plans</div>
                    <div class="nav-item" onclick="switchSection('accounts')">Accounts</div>
                    <div class="nav-item" onclick="switchSection('groups')">Groups & Subgroups</div>
                    <div class="nav-item" onclick="switchSection('emergency-groups')">Emergency Groups</div>
                    <div class="nav-item" onclick="switchSection('tracking')">Tracking</div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- DASHBOARD SECTION -->
                <div id="dashboard-section" class="section active">
                    <div class="section-content">
                        <h2 style="margin-bottom: 30px; font-size: 24px; color: #D4AF37;">Dashboard</h2>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Total Users</p>
                                <h3 style="font-size: 32px; color: #D4AF37;" id="totalUsersCount">-</h3>
                            </div>
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Active Users</p>
                                <h3 style="font-size: 32px; color: #4CAF50;" id="activeUsersCount">-</h3>
                            </div>
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Backend Status</p>
                                <h3 style="font-size: 20px; color: #4CAF50;" id="backendStatus">Running</h3>
                            </div>
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Database Status</p>
                                <h3 style="font-size: 20px; color: #4CAF50;" id="dbStatus">Connected</h3>
                            </div>
                        </div>
                        <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px; margin-bottom: 30px;">
                            <h3 style="color: #FFFFFF; margin-bottom: 16px;">System Information</h3>
                            
                            <div style="margin-bottom: 20px; border-bottom: 1px solid #404040; padding-bottom: 16px;">
                                <p style="color: #b0b0b0; font-size: 12px; font-weight: 600; margin-bottom: 8px;">BACKEND</p>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
                                    <div><span style="color: #b0b0b0;">API Version:</span> <span style="color: #D4AF37;">1.0.0</span></div>
                                    <div><span style="color: #b0b0b0;">Auth Method:</span> <span style="color: #D4AF37;">Username/Password</span></div>
                                    <div><span style="color: #b0b0b0;">Runtime:</span> <span style="color: #D4AF37;">Node.js Express</span></div>
                                    <div id="backendUptime"><span style="color: #b0b0b0;">Server Status:</span> <span style="color: #4CAF50;">Online</span></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px; border-bottom: 1px solid #404040; padding-bottom: 16px;">
                                <p style="color: #b0b0b0; font-size: 12px; font-weight: 600; margin-bottom: 8px;">FRONTEND</p>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
                                    <div><span style="color: #b0b0b0;">Platform:</span> <span style="color: #D4AF37;" id="frontendPlatform">Expo React Native</span></div>
                                    <div><span style="color: #b0b0b0;">SDK Version:</span> <span style="color: #D4AF37;">54.0.x</span></div>
                                    <div><span style="color: #b0b0b0;">Response Time:</span> <span style="color: #D4AF37;" id="frontendResponseTime">~120ms avg</span></div>
                                    <div><span style="color: #b0b0b0;">Error Handling:</span> <span style="color: #4CAF50;">ErrorBoundary Active</span></div>
                                    <div><span style="color: #b0b0b0;">HMR Status:</span> <span style="color: #4CAF50;" id="hmrStatus">Enabled</span></div>
                                    <div><span style="color: #b0b0b0;">Network State:</span> <span style="color: #4CAF50;" id="networkStatus">Online</span></div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px; border-bottom: 1px solid #404040; padding-bottom: 16px;">
                                <p style="color: #b0b0b0; font-size: 12px; font-weight: 600; margin-bottom: 8px;">DEBUGGING</p>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
                                    <div><span style="color: #b0b0b0;">Console Logging:</span> <span style="color: #D4AF37;" id="consoleLogging">Enabled</span></div>
                                    <div><span style="color: #b0b0b0;">Performance Metrics:</span> <span style="color: #D4AF37;" id="performanceMetrics">Tracking</span></div>
                                    <div><span style="color: #b0b0b0;">Error Logs:</span> <span style="color: #D4AF37;" id="errorLogs">Captured</span></div>
                                    <div><span style="color: #b0b0b0;">API Monitoring:</span> <span style="color: #D4AF37;" id="apiMonitoring">Active</span></div>
                                </div>
                            </div>

                            <div>
                                <p style="color: #b0b0b0; font-size: 12px; font-weight: 600; margin-bottom: 8px;">UPDATES</p>
                                <div style="font-size: 14px;">
                                    <div id="lastUpdate"><span style="color: #b0b0b0;">Last Updated:</span> <span style="color: #D4AF37;">Just now</span></div>
                                </div>
                            </div>
                        </div>

                        <h3 style="color: #FFFFFF; margin: 30px 0 20px 0; font-size: 18px;">External Services</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <!-- STREAM.IO -->
                            <div onclick="openServiceModal('stream')" style="cursor: pointer; background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px; transition: all 0.3s; margin-bottom: 0; position: relative;" onmouseover="this.style.borderColor='#D4AF37'; this.style.background='#353535'" onmouseout="this.style.borderColor='#404040'; this.style.background='#2a2a2a'">
                                <div id="streamErrorIndicator" style="position: absolute; top: 12px; right: 12px; font-size: 20px; display: none;"></div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FF0066 0%, #FF6600 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 18px;">S</div>
                                    <div>
                                        <h4 style="color: #FFFFFF; margin: 0 0 4px 0; font-size: 14px; font-weight: 600;">Stream Chat</h4>
                                        <p style="color: #b0b0b0; margin: 0; font-size: 12px;">getstream.io</p>
                                    </div>
                                </div>
                                <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0 0 4px 0;">Status:</p>
                                    <p style="color: #4CAF50; font-size: 13px; font-weight: 600; margin: 0;" id="streamStatus">Connected</p>
                                    <p style="color: #FFB84D; font-size: 11px; margin: 4px 0 0 0; display: none;" id="streamError"></p>
                                </div>
                                <div style="font-size: 12px;">
                                    <p style="color: #b0b0b0; margin: 0 0 4px 0;">API Key: <span style="color: #D4AF37;" id="streamKey">gxfjy67sps69</span></p>
                                    <p style="color: #b0b0b0; margin: 0;">Messaging SDK: <span style="color: #D4AF37;">v11.x</span></p>
                                </div>
                            </div>

                            <!-- SUPABASE -->
                            <div onclick="openServiceModal('supabase')" style="cursor: pointer; background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px; transition: all 0.3s; margin-bottom: 0; position: relative;" onmouseover="this.style.borderColor='#D4AF37'; this.style.background='#353535'" onmouseout="this.style.borderColor='#404040'; this.style.background='#2a2a2a'">
                                <div id="supabaseErrorIndicator" style="position: absolute; top: 12px; right: 12px; font-size: 20px; display: none;"></div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3ECF8E 0%, #24B47E 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 18px;">DB</div>
                                    <div>
                                        <h4 style="color: #FFFFFF; margin: 0 0 4px 0; font-size: 14px; font-weight: 600;">Supabase</h4>
                                        <p style="color: #b0b0b0; margin: 0; font-size: 12px;">supabase.com</p>
                                    </div>
                                </div>
                                <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0 0 4px 0;">Database:</p>
                                    <p style="color: #4CAF50; font-size: 13px; font-weight: 600; margin: 0;" id="supabaseStatus">Connected</p>
                                    <p style="color: #FFB84D; font-size: 11px; margin: 4px 0 0 0; display: none;" id="supabaseError"></p>
                                </div>
                                <div style="font-size: 12px;">
                                    <p style="color: #b0b0b0; margin: 0 0 4px 0;">Type: <span style="color: #D4AF37;">PostgreSQL</span></p>
                                    <p style="color: #b0b0b0; margin: 0;">Region: <span style="color: #D4AF37;" id="supabaseRegion">US East</span></p>
                                </div>
                            </div>

                            <!-- BREVO -->
                            <div onclick="openServiceModal('brevo')" style="cursor: pointer; background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px; transition: all 0.3s; margin-bottom: 0; position: relative;" onmouseover="this.style.borderColor='#D4AF37'; this.style.background='#353535'" onmouseout="this.style.borderColor='#404040'; this.style.background='#2a2a2a'">
                                <div id="brevoErrorIndicator" style="position: absolute; top: 12px; right: 12px; font-size: 20px; display: none;"></div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #7C3AED 0%, #5B21B6 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 18px;">B</div>
                                    <div>
                                        <h4 style="color: #FFFFFF; margin: 0 0 4px 0; font-size: 14px; font-weight: 600;">Brevo</h4>
                                        <p style="color: #b0b0b0; margin: 0; font-size: 12px;">app.brevo.com</p>
                                    </div>
                                </div>
                                <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0 0 4px 0;">Email Service:</p>
                                    <p style="color: #4CAF50; font-size: 13px; font-weight: 600; margin: 0;" id="brevoStatus">Active</p>
                                    <p style="color: #FFB84D; font-size: 11px; margin: 4px 0 0 0; display: none;" id="brevoError"></p>
                                </div>
                                <div style="font-size: 12px;">
                                    <p style="color: #b0b0b0; margin: 0 0 4px 0;">Sender: <span style="color: #D4AF37;">noreply@worldrisk.co.za</span></p>
                                    <p style="color: #b0b0b0; margin: 0;">SMTP: <span style="color: #D4AF37;">Configured</span></p>
                                </div>
                            </div>

                            <!-- EXPO -->
                            <div onclick="openServiceModal('expo')" style="cursor: pointer; background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px; transition: all 0.3s; margin-bottom: 0; position: relative;" onmouseover="this.style.borderColor='#D4AF37'; this.style.background='#353535'" onmouseout="this.style.borderColor='#404040'; this.style.background='#2a2a2a'">
                                <div id="expoErrorIndicator" style="position: absolute; top: 12px; right: 12px; font-size: 20px; display: none;"></div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #D4AF37; font-size: 18px;">E</div>
                                    <div>
                                        <h4 style="color: #FFFFFF; margin: 0 0 4px 0; font-size: 14px; font-weight: 600;">Expo</h4>
                                        <p style="color: #b0b0b0; margin: 0; font-size: 12px;">expo.dev</p>
                                    </div>
                                </div>
                                <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0 0 4px 0;">Frontend Platform:</p>
                                    <p style="color: #4CAF50; font-size: 13px; font-weight: 600; margin: 0;" id="expoStatus">Connected</p>
                                    <p style="color: #FFB84D; font-size: 11px; margin: 4px 0 0 0; display: none;" id="expoError"></p>
                                </div>
                                <div style="font-size: 12px;">
                                    <p style="color: #b0b0b0; margin: 0 0 4px 0;">SDK: <span style="color: #D4AF37;">54.x</span></p>
                                    <p style="color: #b0b0b0; margin: 0;">React Native: <span style="color: #D4AF37;">0.75+</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOGS SECTION -->
                <div id="logs-section" class="section">
                    <div class="section-content">
                        <h2 style="margin-bottom: 30px; font-size: 24px; color: #D4AF37;">System Logs</h2>
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                            <select id="logFilter" style="padding: 10px 16px; background: #1a1a1a; border: 2px solid #404040; border-radius: 6px; color: #FFFFFF; font-size: 14px;">
                                <option value="">All Logs</option>
                                <option value="ERROR">Errors Only</option>
                                <option value="WARN">Warnings Only</option>
                                <option value="INFO">Info Only</option>
                                <option value="backend">Backend Logs</option>
                                <option value="stream">Stream Service</option>
                                <option value="supabase">Supabase Service</option>
                                <option value="brevo">Brevo Service</option>
                            </select>
                            <button onclick="clearLogs()" style="padding: 10px 20px; background: #FF6B6B; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Clear Logs</button>
                            <button onclick="refreshLogs()" style="padding: 10px 20px; background: #D4AF37; color: #1a1a1a; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Refresh</button>
                        </div>

                        <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 8px; max-height: 600px; overflow-y: auto;">
                            <table id="logsTable" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: #2a2a2a;">
                                    <tr>
                                        <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #404040; color: #D4AF37; font-size: 13px; font-weight: 600;">Time</th>
                                        <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #404040; color: #D4AF37; font-size: 13px; font-weight: 600;">Level</th>
                                        <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #404040; color: #D4AF37; font-size: 13px; font-weight: 600;">Source</th>
                                        <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #404040; color: #D4AF37; font-size: 13px; font-weight: 600;">Message</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <tr><td colspan="4" style="padding: 20px; text-align: center; color: #808080;">Loading logs...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- USERS SECTION -->
                <div id="users" class="section">
                    <div class="section-content">
                        <div class="toolbar">
                            <button class="add-user-btn" onclick="openAddUserModal()">+ Add New User</button>
                            <input type="text" class="search-box" id="searchBox" placeholder="Search users...">
                        </div>

                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Account</th>
                                        <th>Billing Plan</th>
                                        <th>Last Visit</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr><td colspan="7" class="loading">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- BILLING PLANS SECTION -->
                <div id="billing-plans" class="section">
                    <div class="section-content">
                        <h2 style="margin-bottom: 20px; font-size: 24px; color: #D4AF37;">Billing Plans</h2>
                        <p style="color: #b0b0b0; margin-bottom: 30px;">Configure and manage user access levels based on billing tiers. Each plan dynamically controls what features and permissions users have access to.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                            <!-- BASIC PLAN -->
                            <div style="background: #2a2a2a; border: 2px solid #404040; border-radius: 12px; padding: 24px; position: relative;">
                                <div style="position: absolute; top: -12px; left: 20px; background: #1a1a1a; padding: 4px 12px; border-radius: 4px;">
                                    <span style="color: #b0b0b0; font-size: 12px; font-weight: 600;">TIER 1</span>
                                </div>
                                <h3 style="color: #D4AF37; font-size: 20px; margin: 12px 0 8px 0;">Basic</h3>
                                <p style="color: #808080; font-size: 13px; margin-bottom: 20px;">Restricted access for standard users</p>
                                
                                <div style="border-top: 1px solid #404040; padding-top: 16px;">
                                    <h4 style="color: #FFFFFF; font-size: 13px; margin-bottom: 12px;">Restrictions:</h4>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="color: #FF6B6B; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10005;</span> Tracking restricted to active only
                                        </li>
                                        <li style="color: #FF6B6B; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10005;</span> Groups controlled by backend only
                                        </li>
                                        <li style="color: #FF6B6B; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10005;</span> Contact list restricted to allowed list
                                        </li>
                                        <li style="color: #FF6B6B; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10005;</span> No access to CMS backend
                                        </li>
                                    </ul>
                                </div>
                                
                                <div style="margin-top: 16px; padding: 12px; background: #1a1a1a; border-radius: 6px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0;">Users: <span id="basicUsersCount" style="color: #D4AF37;">0</span></p>
                                </div>
                            </div>
                            
                            <!-- ADMIN PLAN -->
                            <div style="background: #2a2a2a; border: 2px solid #D4AF37; border-radius: 12px; padding: 24px; position: relative;">
                                <div style="position: absolute; top: -12px; left: 20px; background: #D4AF37; padding: 4px 12px; border-radius: 4px;">
                                    <span style="color: #1a1a1a; font-size: 12px; font-weight: 600;">TIER 2</span>
                                </div>
                                <h3 style="color: #D4AF37; font-size: 20px; margin: 12px 0 8px 0;">Admin</h3>
                                <p style="color: #808080; font-size: 13px; margin-bottom: 20px;">Enhanced access for group administrators</p>
                                
                                <div style="border-top: 1px solid #404040; padding-top: 16px;">
                                    <h4 style="color: #FFFFFF; font-size: 13px; margin-bottom: 12px;">Permissions:</h4>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Group admin on frontend
                                        </li>
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Full contact list access (Admin & below)
                                        </li>
                                        <li style="color: #FFB84D; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#9679;</span> Limited CMS access (allocated by Executive)
                                        </li>
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Standard tracking access
                                        </li>
                                    </ul>
                                </div>
                                
                                <div style="margin-top: 16px; padding: 12px; background: #1a1a1a; border-radius: 6px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0;">Users: <span id="adminUsersCount" style="color: #D4AF37;">0</span></p>
                                </div>
                            </div>
                            
                            <!-- EXECUTIVE PLAN -->
                            <div style="background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); border: 2px solid #4CAF50; border-radius: 12px; padding: 24px; position: relative;">
                                <div style="position: absolute; top: -12px; left: 20px; background: #4CAF50; padding: 4px 12px; border-radius: 4px;">
                                    <span style="color: #1a1a1a; font-size: 12px; font-weight: 600;">TIER 3</span>
                                </div>
                                <h3 style="color: #4CAF50; font-size: 20px; margin: 12px 0 8px 0;">Executive</h3>
                                <p style="color: #808080; font-size: 13px; margin-bottom: 20px;">Full unrestricted access</p>
                                
                                <div style="border-top: 1px solid #404040; padding-top: 16px;">
                                    <h4 style="color: #FFFFFF; font-size: 13px; margin-bottom: 12px;">Full Access:</h4>
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> No restrictions
                                        </li>
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Full CMS backend access
                                        </li>
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Allocate CMS access to Admins
                                        </li>
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Full tracking & group control
                                        </li>
                                        <li style="color: #4CAF50; font-size: 13px; padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px;">&#10003;</span> Manage all user permissions
                                        </li>
                                    </ul>
                                </div>
                                
                                <div style="margin-top: 16px; padding: 12px; background: #1a1a1a; border-radius: 6px;">
                                    <p style="color: #b0b0b0; font-size: 12px; margin: 0;">Users: <span id="executiveUsersCount" style="color: #D4AF37;">0</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Permissions Matrix -->
                        <div style="margin-top: 40px; background: #2a2a2a; border: 1px solid #404040; border-radius: 12px; padding: 24px;">
                            <h3 style="color: #FFFFFF; margin-bottom: 20px; font-size: 18px;">Permission Matrix</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid #404040;">
                                        <th style="text-align: left; padding: 12px; color: #b0b0b0; font-size: 13px;">Feature</th>
                                        <th style="text-align: center; padding: 12px; color: #b0b0b0; font-size: 13px;">Basic</th>
                                        <th style="text-align: center; padding: 12px; color: #D4AF37; font-size: 13px;">Admin</th>
                                        <th style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Executive</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid #333;">
                                        <td style="padding: 12px; color: #FFFFFF; font-size: 13px;">Location Tracking</td>
                                        <td style="text-align: center; padding: 12px; color: #FFB84D; font-size: 13px;">Active Only</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Full</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Full</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #333;">
                                        <td style="padding: 12px; color: #FFFFFF; font-size: 13px;">Group Management</td>
                                        <td style="text-align: center; padding: 12px; color: #FF6B6B; font-size: 13px;">Backend Only</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Frontend Admin</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Full Control</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #333;">
                                        <td style="padding: 12px; color: #FFFFFF; font-size: 13px;">Contact List Access</td>
                                        <td style="text-align: center; padding: 12px; color: #FF6B6B; font-size: 13px;">Allowed Only</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Admin & Below</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">All Users</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #333;">
                                        <td style="padding: 12px; color: #FFFFFF; font-size: 13px;">CMS Backend Access</td>
                                        <td style="text-align: center; padding: 12px; color: #FF6B6B; font-size: 13px;">None</td>
                                        <td style="text-align: center; padding: 12px; color: #FFB84D; font-size: 13px;">Limited</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Full</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px; color: #FFFFFF; font-size: 13px;">Allocate Permissions</td>
                                        <td style="text-align: center; padding: 12px; color: #FF6B6B; font-size: 13px;">None</td>
                                        <td style="text-align: center; padding: 12px; color: #FF6B6B; font-size: 13px;">None</td>
                                        <td style="text-align: center; padding: 12px; color: #4CAF50; font-size: 13px;">Full</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ACCOUNTS SECTION -->
                <div id="accounts" class="section">
                    <div class="section-content">
                        <h2 style="margin-bottom: 20px; font-size: 24px; color: #D4AF37;">Accounts</h2>
                        <p style="color: #b0b0b0; margin-bottom: 20px;">Manage hierarchical accounts with controlled access to channels. Top-level accounts have access to all sub-accounts and their channels.</p>
                        
                        <div class="toolbar">
                            <button class="add-user-btn" onclick="openAddAccountModal()">+ Add Account</button>
                            <input type="text" class="search-box" id="accountSearchBox" placeholder="Search accounts..." onkeyup="filterAccounts()">
                        </div>

                        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 24px; margin-top: 20px;">
                            <!-- Account Tree Panel -->
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 16px;">
                                <h3 style="color: #D4AF37; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                                    Account Hierarchy
                                    <button onclick="loadAccounts()" style="background: transparent; border: 1px solid #404040; color: #b0b0b0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Refresh</button>
                                </h3>
                                <div id="accountTreeContainer" style="max-height: 500px; overflow-y: auto;">
                                    <p style="color: #666; font-size: 13px;">Loading accounts...</p>
                                </div>
                            </div>

                            <!-- Account Details Panel -->
                            <div id="accountDetailsPanel" style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 24px;">
                                <div id="accountDetailsContent">
                                    <p style="color: #666; text-align: center; padding: 40px 0;">Select an account from the tree to view details</p>
                                </div>
                            </div>
                        </div>

                        <!-- Account Statistics -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 24px;">
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 20px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Total Accounts</p>
                                <h3 style="font-size: 28px; color: #D4AF37;" id="totalAccountsCount">0</h3>
                            </div>
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 20px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Top-Level Accounts</p>
                                <h3 style="font-size: 28px; color: #4CAF50;" id="topLevelAccountsCount">0</h3>
                            </div>
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 20px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Sub-Accounts</p>
                                <h3 style="font-size: 28px; color: #FFB84D;" id="subAccountsCount">0</h3>
                            </div>
                            <div style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; padding: 20px;">
                                <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 8px;">Assigned Users</p>
                                <h3 style="font-size: 28px; color: #8B5CF6;" id="assignedUsersCount">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GROUPS SECTION -->
                <div id="groups" class="section">
                    <div class="section-content">
                        <h2 style="margin-bottom: 20px; font-size: 24px; color: #D4AF37;">Groups & Subgroups</h2>
                        <div class="toolbar">
                            <button class="add-user-btn" onclick="openAddGroupModal()">+ Add Group</button>
                            <input type="text" class="search-box" placeholder="Search groups...">
                        </div>
                        <div class="table-container" style="margin-top: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Group Name</th>
                                        <th>Parent Group</th>
                                        <th>Members</th>
                                        <th>Access Level</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="loading">No groups found. Create your first group!</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- EMERGENCY GROUPS SECTION -->
                <div id="emergency-groups" class="section">
                    <div class="section-content">
                        <div class="toolbar">
                            <button class="add-user-btn" onclick="openAddEmergencyGroupModal()">+ Add Emergency Group</button>
                            <input type="text" class="search-box" placeholder="Search emergency groups...">
                        </div>
                        <div class="table-container" style="margin-top: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Group Name</th>
                                        <th>Type</th>
                                        <th>Members</th>
                                        <th>Alert Protocol</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" class="loading">No emergency groups found. Create your first emergency group!</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TRACKING SECTION -->
                <div id="tracking" class="section">
                    <div class="section-content">
                        <h2 style="margin-bottom: 20px; font-size: 24px; color: #D4AF37;">User Tracking</h2>
                        <div style="background: #2a2a2a; border-radius: 8px; padding: 40px; text-align: center; border: 1px solid #404040; margin-bottom: 20px;">
                            <p style="color: #808080; margin-bottom: 20px;">Map will display users with location tracking enabled</p>
                            <div id="mapContainer" style="width: 100%; height: 500px; background: #1a1a1a; border-radius: 4px; border: 1px solid #404040; display: flex; align-items: center; justify-content: center;">
                                <p style="color: #666;">Map initialization loading...</p>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Latitude</th>
                                        <th>Longitude</th>
                                        <th>Last Updated</th>
                                        <th>Device</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" class="loading">Fetching tracked users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SERVICE DETAILS MODALS -->
    <div class="modal" id="serviceModal">
        <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="serviceTitle">Service Details</h2>
                <button class="close-btn" onclick="closeServiceModal()">&times;</button>
            </div>
            <div class="modal-body" id="serviceModalBody"></div>
        </div>
    </div>

    <!-- FORGOT PASSWORD MODAL -->
    <div class="modal" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <button class="close-btn" onclick="closeForgotPasswordModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="error-message" id="resetError" style="display: none;"></div>
                
                <div id="resetStep1">
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        Enter your email and username to verify your account. A reset link will be sent to your email.
                    </p>
                    <div class="form-group">
                        <label for="resetEmail">Email Address</label>
                        <input type="email" id="resetEmail" placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label for="resetUsername">Username</label>
                        <input type="text" id="resetUsername" placeholder="admin">
                    </div>
                    <button onclick="requestPasswordReset()" style="width: 100%; padding: 12px; margin-top: 16px;">
                        Request Reset Link
                    </button>
                </div>

                <div id="resetStep2" style="display: none;">
                    <p style="color: #38a169; background: #f0fff4; padding: 12px; border-radius: 4px; margin-bottom: 20px; font-size: 14px;">
                        Check your email! A password reset link has been sent. Click the link in your email to reset your password. The link expires in 1 hour.
                    </p>
                    <button onclick="closeForgotPasswordModal()" style="width: 100%; padding: 12px; margin-top: 16px;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD GROUP MODAL -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Group</h2>
                <button class="close-btn" onclick="closeGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="error-message" id="groupError" style="display: none;"></div>
                <div class="form-group">
                    <label for="groupName">Group Name</label>
                    <input type="text" id="groupName" placeholder="Enter group name">
                </div>
                <div class="form-group">
                    <label for="groupDescription">Description</label>
                    <input type="text" id="groupDescription" placeholder="Enter group description (optional)">
                </div>
                <div class="form-group">
                    <label>Select Members</label>
                    <div id="groupMembersContainer" style="max-height: 300px; overflow-y: auto; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px;">
                        <p style="color: #808080; text-align: center; padding: 20px;">Loading users...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeGroupModal()">Cancel</button>
                <button class="btn-save" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>

    <!-- ADD EMERGENCY GROUP MODAL -->
    <div class="modal" id="emergencyGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Emergency Group</h2>
                <button class="close-btn" onclick="closeEmergencyGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="error-message" id="emergencyGroupError" style="display: none;"></div>
                <div class="form-group">
                    <label for="emergencyGroupName">Group Name</label>
                    <input type="text" id="emergencyGroupName" placeholder="Enter emergency group name">
                </div>
                <div class="form-group">
                    <label for="emergencyGroupDescription">Description</label>
                    <input type="text" id="emergencyGroupDescription" placeholder="Enter group description (optional)">
                </div>
                <div class="form-group">
                    <label for="alertProtocol">Alert Protocol</label>
                    <select id="alertProtocol" style="width: 100%; padding: 12px; border: 2px solid #404040; border-radius: 8px; background: #1a1a1a; color: #FFFFFF;">
                        <option value="standard">Standard</option>
                        <option value="immediate">Immediate</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Members</label>
                    <div id="emergencyGroupMembersContainer" style="max-height: 300px; overflow-y: auto; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px;">
                        <p style="color: #808080; text-align: center; padding: 20px;">Loading users...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeEmergencyGroupModal()">Cancel</button>
                <button class="btn-save" onclick="createEmergencyGroup()">Create Emergency Group</button>
            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit User</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('general')">General</button>
                    <button class="tab" onclick="switchTab('access')">Access</button>
                    <button class="tab" onclick="switchTab('location')">Location tracking</button>
                    <button class="tab" onclick="switchTab('advanced')">Advanced</button>
                </div>

                <!-- GENERAL TAB -->
                <div id="general" class="tab-content active">
                    <div class="form-group">
                        <label for="userName">Name</label>
                        <input type="text" id="userName" placeholder="User's full name">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" placeholder="user@example.com" disabled>
                    </div>
                    <div class="form-group">
                        <label for="userAccount">Account</label>
                        <input type="text" id="userAccount" placeholder="Account name">
                    </div>
                    <div class="form-group">
                        <label for="userBillingPlan">Billing Plan</label>
                        <select id="userBillingPlan" style="width: 100%; padding: 12px; border: 2px solid #404040; border-radius: 8px; background: #1a1a1a; color: #FFFFFF;" onchange="applyBillingPlanRestrictions()">
                            <option value="basic">Basic</option>
                            <option value="admin">Admin</option>
                            <option value="executive">Executive</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="isEnabled">
                        <label for="isEnabled">Enabled</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="canChangePassword">
                        <label for="canChangePassword">Can change password</label>
                    </div>

                    <!-- PASSWORD SECTION -->
                    <div style="border-top: 1px solid #404040; padding-top: 20px; margin-top: 20px;">
                        <h3 style="color: #D4AF37; font-size: 14px; margin-bottom: 16px;">Login Password</h3>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Leave blank to keep current password">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Re-enter new password">
                        </div>
                        <p style="color: #b0b0b0; font-size: 12px; margin-top: 8px;">
                            Leave both fields blank to keep the current password unchanged.
                        </p>
                    </div>
                </div>

                <!-- ACCESS TAB -->
                <div id="access" class="tab-content">
                    <div class="checkbox-group">
                        <input type="checkbox" id="canCreateGroups">
                        <label for="canCreateGroups">Can create groups and subgroups on front end</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="canAccessCms">
                        <label for="canAccessCms">Can access CMS backend</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="canEditProfile">
                        <label for="canEditProfile">Can edit profile on front end</label>
                    </div>
                </div>

                <!-- LOCATION TRACKING TAB -->
                <div id="location" class="tab-content">
                    <div class="checkbox-group">
                        <input type="checkbox" id="locationTracking">
                        <label for="locationTracking">Enable location tracking</label>
                    </div>
                    <p style="color: #b0b0b0; font-size: 12px; margin-top: 12px;">When enabled, this user can be tracked via the location tracking feature on the front end.</p>
                </div>

                <!-- ADVANCED TAB -->
                <div id="advanced" class="tab-content">
                    <div class="form-group">
                        <label>Creator</label>
                        <input type="text" id="creatorName" disabled placeholder="System">
                    </div>
                    <div class="form-group">
                        <label>Created</label>
                        <input type="text" id="createdDate" disabled>
                    </div>
                    <div class="form-group">
                        <label>Last Visit</label>
                        <input type="text" id="lastVisit" disabled>
                    </div>
                    <div class="form-group">
                        <label>Last Device</label>
                        <input type="text" id="lastDevice" disabled>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" onclick="saveUser()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- ACCOUNT MODAL -->
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="accountModalTitle">Add Account</h2>
                <button class="close-btn" onclick="closeAccountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="accountName">Account Name *</label>
                    <input type="text" id="accountName" placeholder="Enter account name">
                </div>
                <div class="form-group">
                    <label for="accountDescription">Description</label>
                    <input type="text" id="accountDescription" placeholder="Enter description (optional)">
                </div>
                <div class="form-group">
                    <label for="accountParent">Parent Account</label>
                    <select id="accountParent" style="width: 100%; padding: 12px; border: 2px solid #404040; border-radius: 8px; background: #1a1a1a; color: #FFFFFF;">
                        <option value="">None (Top-Level Account)</option>
                    </select>
                    <p style="color: #b0b0b0; font-size: 11px; margin-top: 6px;">Leave empty for top-level account, or select a parent to create a sub-account</p>
                </div>
                <div class="form-group">
                    <label for="accountBillingPlan">Billing Plan</label>
                    <select id="accountBillingPlan" style="width: 100%; padding: 12px; border: 2px solid #404040; border-radius: 8px; background: #1a1a1a; color: #FFFFFF;">
                        <option value="basic">Basic</option>
                        <option value="admin">Admin</option>
                        <option value="executive">Executive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAccountModal()">Cancel</button>
                <button class="btn-save" id="saveAccountBtn" onclick="saveAccount()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- ASSIGN USERS TO ACCOUNT MODAL -->
    <div class="modal" id="assignUsersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assign Users to Account</h2>
                <button class="close-btn" onclick="closeAssignUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #b0b0b0; margin-bottom: 16px;">Select users to assign to <span id="assignUsersAccountName" style="color: #D4AF37;"></span></p>
                <div id="assignUsersContainer" style="max-height: 400px; overflow-y: auto; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px;">
                    <p style="color: #808080; text-align: center; padding: 20px;">Loading users...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAssignUsersModal()">Cancel</button>
                <button class="btn-save" onclick="saveAssignedUsers()">Assign Users</button>
            </div>
        </div>
    </div>

    <!-- ASSIGN CHANNELS TO ACCOUNT MODAL -->
    <div class="modal" id="assignChannelsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assign Channels to Account</h2>
                <button class="close-btn" onclick="closeAssignChannelsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #b0b0b0; margin-bottom: 16px;">Select channels to assign to <span id="assignChannelsAccountName" style="color: #D4AF37;"></span></p>
                <div class="form-group">
                    <label for="channelAccessLevel">Access Level</label>
                    <select id="channelAccessLevel" style="width: 100%; padding: 12px; border: 2px solid #404040; border-radius: 8px; background: #1a1a1a; color: #FFFFFF;">
                        <option value="read_only">Read Only</option>
                        <option value="read_write" selected>Read & Write</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="assignChannelsContainer" style="max-height: 350px; overflow-y: auto; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 12px;">
                    <p style="color: #808080; text-align: center; padding: 20px;">Loading channels...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAssignChannelsModal()">Cancel</button>
                <button class="btn-save" onclick="saveAssignedChannels()">Assign Channels</button>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let currentUserId = null;
        let currentUserData = null;
        let currentResetToken = null;
        let currentEmail = null;

        // Check if logged in
        if (token) {
            showDashboard();
            loadUsers();
            loadServiceStatus();
        }

        // Load and display service status dynamically
        async function loadServiceStatus() {
            try {
                const response = await fetch('/api/services/status');
                const services = await response.json();

                // Update each service with fetched status
                updateServiceCard('stream', services.stream);
                updateServiceCard('supabase', services.supabase);
                updateServiceCard('brevo', services.brevo);
                updateServiceCard('expo', services.expo);
            } catch (error) {
                console.error('Error loading service status:', error);
            }
        }

        function updateServiceCard(serviceName, serviceData) {
            const statusElement = document.getElementById(serviceName + 'Status');
            const errorElement = document.getElementById(serviceName + 'Error');
            const indicatorElement = document.getElementById(serviceName + 'ErrorIndicator');

            if (serviceData.status === 'connected') {
                statusElement.textContent = 'Connected';
                statusElement.style.color = '#4CAF50';
                errorElement.style.display = 'none';
                indicatorElement.style.display = 'none';
            } else if (serviceData.status === 'disconnected' || serviceData.status === 'error') {
                statusElement.textContent = serviceData.status === 'disconnected' ? 'Disconnected' : 'Error';
                statusElement.style.color = '#FF6B6B';
                
                if (serviceData.error) {
                    errorElement.textContent = serviceData.error;
                    errorElement.style.display = 'block';
                }

                // Show appropriate indicator
                if (serviceData.severity === 'critical') {
                    indicatorElement.textContent = '';
                    indicatorElement.title = 'Critical Error - App affected';
                } else if (serviceData.severity === 'minor') {
                    indicatorElement.textContent = '';
                    indicatorElement.title = 'Caution - Minor error';
                }
                indicatorElement.style.display = 'block';
            }
        }

        // SEND VERIFICATION CODE
        async function sendVerificationCode() {
            const email = document.getElementById('email').value;
            const sendBtn = document.getElementById('sendCodeBtn');
            const errorDiv = document.getElementById('loginError');

            if (!email) {
                errorDiv.textContent = 'Please enter your email';
                errorDiv.style.display = 'block';
                return;
            }

            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/auth/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send code');
                }

                currentEmail = email;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                document.getElementById('code').focus();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Code';
            }
        }

        // VERIFY CODE
        async function verifyCode() {
            const code = document.getElementById('code').value;
            const verifyBtn = document.getElementById('verifyCodeBtn');
            const errorDiv = document.getElementById('loginError');

            if (!code || code.length !== 6) {
                errorDiv.textContent = 'Please enter a valid 6-digit code';
                errorDiv.style.display = 'block';
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/auth/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, code })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Verification failed');
                }

                token = data.token;
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(data.user));

                showDashboard();
                loadUsers();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify & Sign In';
            }
        }

        // GO BACK TO EMAIL
        function goBackToEmail() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            document.getElementById('code').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('email').focus();
        }

        // Allow Enter key in code field
        document.getElementById('code')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyCode();
        });

        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('currentUser').textContent = user.username || user.email;
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';

                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        const lastVisit = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
                        const status = user.permissions?.is_enabled ? 'Enabled' : 'Disabled';
                        const statusClass = user.permissions?.is_enabled ? 'enabled' : 'disabled';

                        row.innerHTML = `
                            <td>${user.username || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>${user.account_name || 'N/A'}</td>
                            <td>${user.billing_plan || 'N/A'}</td>
                            <td>${lastVisit}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>
                                <div class="actions">
                                    <button class="edit-btn" onclick="openEditUserModal('${user.id}')">Edit</button>
                                    <button class="delete-btn" onclick="deleteUser('${user.id}')">Delete</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    // Update dashboard count
                    document.getElementById('totalUsersCount').textContent = data.total || data.users.length;
                    const activeCount = data.users.filter(u => u.permissions?.is_enabled).length;
                    document.getElementById('activeUsersCount').textContent = activeCount;
                    
                    // Update billing plan counts
                    updateBillingPlanCounts(data.users);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">No users found</td></tr>';
                    updateBillingPlanCounts([]);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // SECTION SWITCHING
        function switchSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            // Remove active from nav items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Mark nav item as active
            event.target.classList.add('active');
            
            // Load logs when switching to logs section
            if (sectionId === 'logs-section') {
                loadLogs();
            }
        }

        // SERVICE MODAL FUNCTIONS
        const serviceDetails = {
            stream: {
                title: 'Stream Chat - Detailed Connection',
                html: `
                    <h3 style="color: #D4AF37; margin-bottom: 16px;">Connection Status</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                        <p><span style="color: #b0b0b0;">Status:</span> <span style="color: #4CAF50; font-weight: 600;">Connected & Operational</span></p>
                        <p><span style="color: #b0b0b0;">API Key:</span> <span style="color: #D4AF37;">gxfjy67sps69</span></p>
                        <p><span style="color: #b0b0b0;">Region:</span> <span style="color: #D4AF37;">Global</span></p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">APIs & Endpoints</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #D4AF37; font-weight: 600;">Chat API:</p>
                        <p style="color: #b0b0b0;"> POST /channels - Create/Update channels</p>
                        <p style="color: #b0b0b0;"> GET /channels - List channels</p>
                        <p style="color: #b0b0b0;"> POST /messages - Send messages</p>
                        <p style="color: #b0b0b0;"> WebSocket: Real-time message sync</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Functions in Use</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #b0b0b0;"> createChannel() - Initialize group channels</p>
                        <p style="color: #b0b0b0;"> sendMessage() - Post messages with emergency flag</p>
                        <p style="color: #b0b0b0;"> listenToMessages() - Real-time updates</p>
                        <p style="color: #b0b0b0;"> getUserInfo() - User profile sync</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Error Handling & Debugging</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Common Errors:</p>
                        <p style="color: #FFD700;"> Connection Timeout (30s)</p>
                        <p style="color: #b0b0b0;"> Auto-retry with exponential backoff</p>
                        <p style="color: #b0b0b0;"> Check frontend network connection</p>
                        <p style="color: #b0b0b0;"> Verify Stream API Key in environment</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Invalid API Key</p>
                        <p style="color: #b0b0b0;"> Fallback to defensive initialization</p>
                        <p style="color: #b0b0b0;"> Verify key in EXPO_PUBLIC_STREAM_API_KEY</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Message Send Failure</p>
                        <p style="color: #b0b0b0;"> Queue locally & retry when online</p>
                        <p style="color: #b0b0b0;"> Check browser DevTools > Network tab</p>
                    </div>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Debug Tools:</p>
                        <p style="color: #b0b0b0;"> Frontend: console.log() in utils/streamClient.ts</p>
                        <p style="color: #b0b0b0;"> Monitor: Browser DevTools > Console tab</p>
                        <p style="color: #b0b0b0;"> Test: Use Channel List screen to verify connection</p>
                        <p style="color: #b0b0b0;"> View: Check chat for real-time message updates</p>
                    </div>
                `
            },
            supabase: {
                title: 'Supabase - Database Connection',
                html: `
                    <h3 style="color: #D4AF37; margin-bottom: 16px;">Connection Status</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                        <p><span style="color: #b0b0b0;">Status:</span> <span style="color: #4CAF50; font-weight: 600;">Connected</span></p>
                        <p><span style="color: #b0b0b0;">Database:</span> <span style="color: #D4AF37;">PostgreSQL (Neon)</span></p>
                        <p><span style="color: #b0b0b0;">Region:</span> <span style="color: #D4AF37;">US East</span></p>
                        <p><span style="color: #b0b0b0;">Response Time:</span> <span style="color: #D4AF37;">~45ms avg</span></p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Tables & Queries</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #D4AF37; font-weight: 600;">Core Tables:</p>
                        <p style="color: #b0b0b0;"> users (id, email, username, permissions JSONB)</p>
                        <p style="color: #b0b0b0;"> groups (id, name, parent_id, members)</p>
                        <p style="color: #b0b0b0;"> messages (id, channel_id, content)</p>
                        <p style="color: #b0b0b0;"> location_tracking (user_id, lat, lng)</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Common Operations</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #b0b0b0;"> SELECT * FROM users - Fetch all users</p>
                        <p style="color: #b0b0b0;"> INSERT INTO users - Create new user</p>
                        <p style="color: #b0b0b0;"> UPDATE users SET permissions - Update perms</p>
                        <p style="color: #b0b0b0;"> Real-time subscriptions via websocket</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Error Handling & Debugging</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Common Errors:</p>
                        <p style="color: #FFD700;"> Connection Failed</p>
                        <p style="color: #b0b0b0;"> Log error, retry with backoff</p>
                        <p style="color: #b0b0b0;"> Verify SUPABASE_URL & SERVICE_ROLE_KEY set</p>
                        <p style="color: #b0b0b0;"> Check Supabase project is active</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Query Timeout (5s)</p>
                        <p style="color: #b0b0b0;"> Abort & return empty result</p>
                        <p style="color: #b0b0b0;"> Monitor database performance metrics</p>
                        <p style="color: #b0b0b0;"> Check table indexes for slow queries</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Auth Failed</p>
                        <p style="color: #b0b0b0;"> Clear token, redirect to login</p>
                        <p style="color: #b0b0b0;"> Verify user exists in database</p>
                    </div>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Debug Tools:</p>
                        <p style="color: #b0b0b0;"> Backend: Check server logs in console</p>
                        <p style="color: #b0b0b0;"> Dashboard: View this status page (refreshes every session)</p>
                        <p style="color: #b0b0b0;"> SQL: Use Supabase SQL Editor for direct queries</p>
                        <p style="color: #b0b0b0;"> Monitor: Track API response times in Network tab</p>
                    </div>
                `
            },
            brevo: {
                title: 'Brevo - Email Service',
                html: `
                    <h3 style="color: #D4AF37; margin-bottom: 16px;">Service Status</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                        <p><span style="color: #b0b0b0;">Status:</span> <span style="color: #4CAF50; font-weight: 600;">Active & Operational</span></p>
                        <p><span style="color: #b0b0b0;">Sender Email:</span> <span style="color: #D4AF37;">noreply@worldrisk.co.za</span></p>
                        <p><span style="color: #b0b0b0;">SMTP:</span> <span style="color: #D4AF37;">smtp-relay.brevo.com:587</span></p>
                        <p><span style="color: #b0b0b0;">Authentication:</span> <span style="color: #D4AF37;">API Key + SMTP</span></p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Email Templates</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #b0b0b0;"> Verification Code (6-digit OTP)</p>
                        <p style="color: #b0b0b0;"> Password Reset Link</p>
                        <p style="color: #b0b0b0;"> Account Confirmation</p>
                        <p style="color: #b0b0b0;"> Emergency Alert Notification</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">API Endpoints</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #b0b0b0;">POST /smtp/email - Send transactional email</p>
                        <p style="color: #b0b0b0;">GET /smtp/stats - Email delivery stats</p>
                        <p style="color: #b0b0b0;">Rate Limit: 500 emails/hour</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Error Handling & Debugging</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Common Errors:</p>
                        <p style="color: #FFD700;"> Rate Limit Exceeded (500 emails/hour)</p>
                        <p style="color: #b0b0b0;"> Queue email & retry after 60s</p>
                        <p style="color: #b0b0b0;"> Monitor email send frequency</p>
                        <p style="color: #b0b0b0;"> Implement retry queue in backend</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Invalid Email Address</p>
                        <p style="color: #b0b0b0;"> Validate & log error</p>
                        <p style="color: #b0b0b0;"> Check user email format</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> SMTP Connection Failed</p>
                        <p style="color: #b0b0b0;"> Fallback to REST API (auto-enabled)</p>
                        <p style="color: #b0b0b0;"> Verify BREVO_API_KEY configured</p>
                    </div>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Debug Tools:</p>
                        <p style="color: #b0b0b0;"> Backend Logs: Check console for email send attempts</p>
                        <p style="color: #b0b0b0;"> Brevo Dashboard: View sent/failed emails at app.brevo.com</p>
                        <p style="color: #b0b0b0;"> Test Send: Use password reset feature to trigger email</p>
                        <p style="color: #b0b0b0;"> Monitor: Check spam folders for email delivery issues</p>
                    </div>
                `
            },
            expo: {
                title: 'Expo - Frontend Platform',
                html: `
                    <h3 style="color: #D4AF37; margin-bottom: 16px;">Platform Status</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                        <p><span style="color: #b0b0b0;">Status:</span> <span style="color: #4CAF50; font-weight: 600;">Connected & Building</span></p>
                        <p><span style="color: #b0b0b0;">SDK Version:</span> <span style="color: #D4AF37;">54.0.x</span></p>
                        <p><span style="color: #b0b0b0;">React Native:</span> <span style="color: #D4AF37;">0.75+</span></p>
                        <p><span style="color: #b0b0b0;">Build Method:</span> <span style="color: #D4AF37;">EAS Build</span></p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Features Enabled</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #b0b0b0;"> Hot Module Reloading (HMR)</p>
                        <p style="color: #b0b0b0;"> Over-the-Air Updates</p>
                        <p style="color: #b0b0b0;"> Push Notifications</p>
                        <p style="color: #b0b0b0;"> Gesture Handler & Reanimated</p>
                        <p style="color: #b0b0b0;"> Async Storage (Session Persistence)</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Core Libraries</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 20px; font-size: 13px;">
                        <p style="color: #b0b0b0;"> react-navigation 7+ - App navigation</p>
                        <p style="color: #b0b0b0;"> expo-camera - Camera access</p>
                        <p style="color: #b0b0b0;"> expo-location - GPS tracking</p>
                        <p style="color: #b0b0b0;"> expo-notifications - Push alerts</p>
                    </div>
                    <h3 style="color: #D4AF37; margin: 20px 0 16px 0;">Error Handling & Debugging</h3>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; margin-bottom: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Common Errors:</p>
                        <p style="color: #FFD700;"> App Crash / Unhandled Error</p>
                        <p style="color: #b0b0b0;"> ErrorBoundary catches & offers restart</p>
                        <p style="color: #b0b0b0;"> Frontend logs error details to console</p>
                        <p style="color: #b0b0b0;"> Click "Try Again" to restart safely</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Module Load Failed / HMR Issues</p>
                        <p style="color: #b0b0b0;"> Clear cache (Ctrl+Shift+R on web)</p>
                        <p style="color: #b0b0b0;"> Expo Go: Force restart the app</p>
                        <p style="color: #b0b0b0;"> Check dependency versions in package.json</p>
                        
                        <p style="color: #FFD700; margin-top: 12px;"> Permission Denied</p>
                        <p style="color: #b0b0b0;"> Request permission with graceful fallback</p>
                        <p style="color: #b0b0b0;"> Location/camera disabled: show UI message</p>
                    </div>
                    <div style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 16px; font-size: 13px;">
                        <p style="color: #FFD700; font-weight: 600;">Debug Tools & Performance:</p>
                        <p style="color: #b0b0b0;"> Console: Browser DevTools > Console tab shows all errors</p>
                        <p style="color: #b0b0b0;"> Network: DevTools > Network monitors API calls & response times</p>
                        <p style="color: #b0b0b0;"> Performance: React DevTools Profiler shows render performance</p>
                        <p style="color: #b0b0b0;"> HMR Status: Check if hot reload is working (Shows in console)</p>
                        <p style="color: #b0b0b0;"> Frontend Logs: Available at app startup & stored in AsyncStorage</p>
                    </div>
                `
            }
        };

        function openServiceModal(service) {
            const data = serviceDetails[service];
            document.getElementById('serviceTitle').textContent = data.title;
            document.getElementById('serviceModalBody').innerHTML = data.html;
            document.getElementById('serviceModal').classList.add('active');
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').classList.remove('active');
        }

        async function openEditUserModal(userId) {
            currentUserId = userId;
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch user');
                currentUserData = await response.json();

                document.getElementById('modalTitle').textContent = 'Edit User';
                document.getElementById('userName').value = currentUserData.username || '';
                document.getElementById('userEmail').value = currentUserData.email || '';
                document.getElementById('userAccount').value = currentUserData.account_name || '';
                document.getElementById('userBillingPlan').value = currentUserData.billing_plan || 'basic';
                document.getElementById('creatorName').value = currentUserData.creator_id ? (currentUserData.creator_id === currentUserData.id ? 'System' : currentUserData.creator_id) : 'System';
                document.getElementById('createdDate').value = currentUserData.created_at ? new Date(currentUserData.created_at).toLocaleString() : '';
                document.getElementById('lastVisit').value = currentUserData.last_login ? new Date(currentUserData.last_login).toLocaleString() : 'Never';
                document.getElementById('lastDevice').value = currentUserData.last_device || '';

                const perms = currentUserData.permissions || {};
                document.getElementById('isEnabled').checked = perms.is_enabled !== false;
                document.getElementById('canChangePassword').checked = perms.can_change_password !== false;
                document.getElementById('canCreateGroups').checked = perms.can_create_groups || false;
                document.getElementById('canAccessCms').checked = perms.can_access_cms || false;
                document.getElementById('canEditProfile').checked = perms.can_edit_profile || false;
                
                document.getElementById('locationTracking').checked = currentUserData.location_tracking || false;

                // Clear password fields when editing (user can optionally set new password)
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                // Apply billing plan restrictions dynamically
                applyBillingPlanRestrictions();

                document.getElementById('userModal').classList.add('active');
            } catch (error) {
                console.error('Error loading user:', error);
                alert('Failed to load user');
            }
        }

        function openAddUserModal() {
            currentUserId = null;
            currentUserData = null;
            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('userEmail').disabled = false;
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userAccount').value = '';
            document.getElementById('userBillingPlan').value = 'basic';
            document.getElementById('creatorName').value = '';
            document.getElementById('createdDate').value = '';
            document.getElementById('lastVisit').value = '';
            document.getElementById('lastDevice').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            document.getElementById('isEnabled').checked = true;
            document.getElementById('canChangePassword').checked = true;
            document.getElementById('canCreateGroups').checked = false;
            document.getElementById('canAccessCms').checked = false;
            document.getElementById('canEditProfile').checked = false;
            
            document.getElementById('locationTracking').checked = false;

            // Apply billing plan restrictions dynamically for new users
            applyBillingPlanRestrictions();

            document.getElementById('userModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
            currentUserId = null;
            currentUserData = null;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function saveUser() {
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value;
            const userAccount = document.getElementById('userAccount').value;
            const billingPlan = document.getElementById('userBillingPlan').value;
            const locationTracking = document.getElementById('locationTracking').checked;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords if provided
            if (newPassword || confirmPassword) {
                if (!newPassword || !confirmPassword) {
                    alert('Please fill in both password fields or leave them blank');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('Password must be at least 6 characters long');
                    return;
                }
            }

            // Get billing plan configuration and apply restrictions
            const planConfig = BILLING_PLANS[billingPlan] || BILLING_PLANS.basic;
            const planPerms = planConfig.permissions;
            
            // Build permissions based on billing plan restrictions
            const permissions = {
                is_enabled: document.getElementById('isEnabled').checked,
                can_change_password: document.getElementById('canChangePassword').checked,
                // Apply billing plan restrictions - if plan doesn't allow, force false
                can_create_groups: planPerms.can_create_groups === true ? document.getElementById('canCreateGroups').checked : false,
                can_access_cms: planPerms.can_access_cms === true ? document.getElementById('canAccessCms').checked : (planPerms.can_access_cms === 'limited' ? 'limited' : false),
                can_edit_profile: planPerms.can_edit_profile === true ? document.getElementById('canEditProfile').checked : false,
                // Store additional billing plan metadata
                location_tracking_level: planPerms.location_tracking,
                contact_list_access: planPerms.contact_list,
                group_management_level: planPerms.group_management
            };

            try {
                if (currentUserId) {
                    // Update existing user
                    const updateData = {
                        username: userName,
                        account_name: userAccount,
                        billing_plan: billingPlan,
                        location_tracking: locationTracking,
                        permissions
                    };

                    if (newPassword) {
                        updateData.password = newPassword;
                    }

                    const response = await fetch(`/api/users/${currentUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!response.ok) throw new Error('Failed to update user');
                } else {
                    // Create new user
                    if (!userEmail) {
                        alert('Email is required when creating a new user');
                        return;
                    }
                    if (!newPassword) {
                        alert('Password is required when creating a new user');
                        return;
                    }

                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            email: userEmail,
                            username: userName,
                            password: newPassword,
                            account_name: userAccount,
                            billing_plan: billingPlan,
                            permissions
                        })
                    });

                    if (!response.ok) throw new Error('Failed to create user');
                }

                closeModal();
                loadUsers();
                alert('User saved successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to delete user');
                loadUsers();
                alert('User deleted successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            token = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('loginForm').reset();
        }

        // PASSWORD RESET FUNCTIONS
        function showForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('resetStep1').style.display = 'block';
            document.getElementById('resetStep2').style.display = 'none';
            document.getElementById('resetError').style.display = 'none';
            currentResetToken = null;
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('resetEmail').value = '';
            document.getElementById('resetUsername').value = '';
            document.getElementById('resetError').style.display = 'none';
            currentResetToken = null;
        }

        async function requestPasswordReset() {
            const email = document.getElementById('resetEmail').value;
            const resetError = document.getElementById('resetError');

            if (!email) {
                resetError.textContent = 'Email is required';
                resetError.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/auth/request-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                // Show success message regardless of response code
                document.getElementById('resetStep1').style.display = 'none';
                document.getElementById('resetStep2').style.display = 'block';
                resetError.style.display = 'none';
            } catch (error) {
                resetError.textContent = 'Network error: ' + error.message;
                resetError.style.display = 'block';
            }
        }

        // ============= LOGS FUNCTIONS =============
        async function loadLogs(filter = '') {
            try {
                const filterParam = filter ? `?filter=${encodeURIComponent(filter)}` : '';
                const response = await fetch(`/api/logs${filterParam}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load logs');
                
                const logs = await response.json();
                renderLogs(logs);
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsTableBody').innerHTML = 
                    '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #FF6B6B;">Failed to load logs: ' + error.message + '</td></tr>';
            }
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #808080;">No logs found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const levelColor = log.level === 'ERROR' ? '#FF6B6B' : 
                                   log.level === 'WARN' ? '#FFB84D' : 
                                   log.level === 'INFO' ? '#4CAF50' : '#FFFFFF';
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                const details = log.details ? ` - ${log.details}` : '';
                
                return `
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding: 12px 16px; color: #b0b0b0; font-size: 12px; white-space: nowrap;">${timestamp}</td>
                        <td style="padding: 12px 16px;"><span style="color: ${levelColor}; font-weight: 600; font-size: 12px;">${log.level}</span></td>
                        <td style="padding: 12px 16px; color: #D4AF37; font-size: 13px;">${log.source}</td>
                        <td style="padding: 12px 16px; color: #FFFFFF; font-size: 13px;">${log.message}${details}</td>
                    </tr>
                `;
            }).join('');
        }

        function refreshLogs() {
            const filter = document.getElementById('logFilter').value;
            loadLogs(filter);
        }

        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs?')) return;
            
            try {
                const response = await fetch('/api/logs', {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to clear logs');
                
                loadLogs();
                alert('Logs cleared successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Add event listener for log filter
        document.getElementById('logFilter')?.addEventListener('change', refreshLogs);

        // ============= GROUP MANAGEMENT FUNCTIONS =============
        
        let availableUsers = [];

        async function fetchAvailableUsers() {
            try {
                const response = await fetch('/api/users/available', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch users');
                availableUsers = await response.json();
                return availableUsers;
            } catch (error) {
                console.error('Error fetching users:', error);
                return [];
            }
        }

        function renderMembersCheckboxes(containerId, prefix) {
            const users = availableUsers;
            const container = document.getElementById(containerId);
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p style="color: #808080; text-align: center; padding: 20px;">No users available</p>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="checkbox-group" style="margin-bottom: 8px;">
                    <input type="checkbox" id="${prefix}_${user.id}" value="${user.id}" class="${prefix}-member">
                    <label for="${prefix}_${user.id}" style="margin: 0; font-weight: normal; color: #FFFFFF;">${user.username} (${user.email})</label>
                </div>
            `).join('');
        }

        async function openAddGroupModal() {
            document.getElementById('groupError').style.display = 'none';
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            
            // Fetch users
            await fetchAvailableUsers();
            renderMembersCheckboxes('groupMembersContainer', 'group');
            
            document.getElementById('groupModal').classList.add('active');
        }

        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('active');
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            const errorDiv = document.getElementById('groupError');
            const btn = event.target;

            if (!name) {
                errorDiv.textContent = 'Group name is required';
                errorDiv.style.display = 'block';
                return;
            }

            const memberCheckboxes = document.querySelectorAll('.group-member:checked');
            const memberIds = Array.from(memberCheckboxes).map(cb => cb.value);

            btn.disabled = true;
            btn.textContent = 'Creating...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        memberIds
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create group');
                }

                alert('Group created successfully!');
                closeGroupModal();
                // Optionally refresh groups list here
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Group';
            }
        }

        async function openAddEmergencyGroupModal() {
            document.getElementById('emergencyGroupError').style.display = 'none';
            document.getElementById('emergencyGroupName').value = '';
            document.getElementById('emergencyGroupDescription').value = '';
            document.getElementById('alertProtocol').value = 'standard';
            
            // Fetch users
            await fetchAvailableUsers();
            renderMembersCheckboxes('emergencyGroupMembersContainer', 'emergency');
            
            document.getElementById('emergencyGroupModal').classList.add('active');
        }

        function closeEmergencyGroupModal() {
            document.getElementById('emergencyGroupModal').classList.remove('active');
        }

        async function createEmergencyGroup() {
            const name = document.getElementById('emergencyGroupName').value.trim();
            const description = document.getElementById('emergencyGroupDescription').value.trim();
            const alertProtocol = document.getElementById('alertProtocol').value;
            const errorDiv = document.getElementById('emergencyGroupError');
            const btn = event.target;

            if (!name) {
                errorDiv.textContent = 'Emergency group name is required';
                errorDiv.style.display = 'block';
                return;
            }

            const memberCheckboxes = document.querySelectorAll('.emergency-member:checked');
            const memberIds = Array.from(memberCheckboxes).map(cb => cb.value);

            btn.disabled = true;
            btn.textContent = 'Creating...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/emergency-groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        alertProtocol,
                        memberIds
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create emergency group');
                }

                alert('Emergency group created successfully!');
                closeEmergencyGroupModal();
                // Optionally refresh emergency groups list here
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Emergency Group';
            }
        }

        // ============= BILLING PLAN CONFIGURATION =============
        
        const BILLING_PLANS = {
            basic: {
                name: 'Basic',
                tier: 1,
                permissions: {
                    can_create_groups: false,
                    can_access_cms: false,
                    can_edit_profile: false,
                    location_tracking: 'active_only',
                    contact_list: 'allowed_only',
                    group_management: 'backend_only'
                }
            },
            admin: {
                name: 'Admin',
                tier: 2,
                permissions: {
                    can_create_groups: true,
                    can_access_cms: 'limited',
                    can_edit_profile: true,
                    location_tracking: 'full',
                    contact_list: 'admin_and_below',
                    group_management: 'frontend_admin'
                }
            },
            executive: {
                name: 'Executive',
                tier: 3,
                permissions: {
                    can_create_groups: true,
                    can_access_cms: true,
                    can_edit_profile: true,
                    location_tracking: 'full',
                    contact_list: 'all',
                    group_management: 'full_control',
                    can_allocate_permissions: true
                }
            }
        };

        // Apply billing plan restrictions when plan changes
        function applyBillingPlanRestrictions() {
            const plan = document.getElementById('userBillingPlan').value;
            const config = BILLING_PLANS[plan];
            
            if (!config) return;

            // Update permission checkboxes based on billing plan
            const canCreateGroups = document.getElementById('canCreateGroups');
            const canAccessCms = document.getElementById('canAccessCms');
            const canEditProfile = document.getElementById('canEditProfile');
            const locationTracking = document.getElementById('locationTracking');

            if (canCreateGroups) {
                canCreateGroups.checked = config.permissions.can_create_groups === true;
                canCreateGroups.disabled = plan === 'basic';
            }
            
            if (canAccessCms) {
                canAccessCms.checked = config.permissions.can_access_cms === true;
                canAccessCms.disabled = plan === 'basic';
            }
            
            if (canEditProfile) {
                canEditProfile.checked = config.permissions.can_edit_profile === true;
                canEditProfile.disabled = plan === 'basic';
            }
            
            if (locationTracking) {
                locationTracking.checked = config.permissions.location_tracking === 'full';
                locationTracking.disabled = plan === 'basic';
            }

            // Show restriction notice for Basic plan
            let restrictionNotice = document.getElementById('billingRestrictionNotice');
            if (!restrictionNotice) {
                restrictionNotice = document.createElement('div');
                restrictionNotice.id = 'billingRestrictionNotice';
                restrictionNotice.style.cssText = 'background: #2a2a2a; border: 1px solid #FF6B6B; border-radius: 6px; padding: 12px; margin-top: 16px; display: none;';
                const accessTab = document.getElementById('access');
                if (accessTab) accessTab.appendChild(restrictionNotice);
            }
            
            if (plan === 'basic') {
                restrictionNotice.innerHTML = '<p style="color: #FF6B6B; font-size: 13px; margin: 0;"><strong>Basic Plan Restrictions:</strong> This user has limited access. All permissions are controlled by the backend.</p>';
                restrictionNotice.style.display = 'block';
            } else if (plan === 'admin') {
                restrictionNotice.innerHTML = '<p style="color: #FFB84D; font-size: 13px; margin: 0;"><strong>Admin Plan:</strong> CMS access is limited and must be allocated by an Executive user.</p>';
                restrictionNotice.style.display = 'block';
            } else {
                restrictionNotice.style.display = 'none';
            }
        }

        // Update billing plan user counts
        function updateBillingPlanCounts(users) {
            let basicCount = 0;
            let adminCount = 0;
            let executiveCount = 0;
            
            if (users && users.length > 0) {
                users.forEach(user => {
                    const plan = (user.billing_plan || '').toLowerCase();
                    if (plan === 'basic') basicCount++;
                    else if (plan === 'admin') adminCount++;
                    else if (plan === 'executive' || plan === 'enterprise') executiveCount++;
                });
            }
            
            const basicEl = document.getElementById('basicUsersCount');
            const adminEl = document.getElementById('adminUsersCount');
            const executiveEl = document.getElementById('executiveUsersCount');
            
            if (basicEl) basicEl.textContent = basicCount;
            if (adminEl) adminEl.textContent = adminCount;
            if (executiveEl) executiveEl.textContent = executiveCount;
        }

        // Get billing plan permissions for API calls
        function getBillingPlanPermissions(plan) {
            return BILLING_PLANS[plan] ? BILLING_PLANS[plan].permissions : BILLING_PLANS.basic.permissions;
        }

        // Check if user can access feature based on billing plan
        function canAccessFeature(userPlan, feature) {
            const config = BILLING_PLANS[userPlan] || BILLING_PLANS.basic;
            const permission = config.permissions[feature];
            
            if (permission === true || permission === 'full' || permission === 'all' || permission === 'full_control') {
                return true;
            }
            if (permission === 'limited' || permission === 'admin_and_below' || permission === 'frontend_admin' || permission === 'active_only' || permission === 'allowed_only') {
                return 'limited';
            }
            return false;
        }

        // ============= ACCOUNTS MANAGEMENT =============
        let accountsData = { accounts: [], tree: [] };
        let currentAccountId = null;
        let selectedAccountForUsers = null;
        let selectedAccountForChannels = null;

        // Load accounts from API
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    console.warn('Accounts API not available - tables may not exist yet');
                    document.getElementById('accountTreeContainer').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: #FFB84D; margin-bottom: 10px;">Accounts feature requires database setup</p>
                            <p style="color: #666; font-size: 12px;">Run the SQL queries to create the accounts table</p>
                        </div>
                    `;
                    return;
                }
                
                accountsData = await response.json();
                renderAccountTree();
                updateAccountStats();
            } catch (error) {
                console.error('Load accounts error:', error);
                document.getElementById('accountTreeContainer').innerHTML = `
                    <p style="color: #FF6B6B; text-align: center; padding: 20px;">Error loading accounts</p>
                `;
            }
        }

        // Render account tree
        function renderAccountTree() {
            const container = document.getElementById('accountTreeContainer');
            
            if (!accountsData.tree || accountsData.tree.length === 0) {
                container.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 20px;">No accounts yet. Create your first account!</p>
                `;
                return;
            }

            const renderNode = (node, level = 0) => {
                const hasChildren = node.children && node.children.length > 0;
                const indent = level * 20;
                
                let html = `
                    <div class="account-node" style="padding: 8px 8px 8px ${indent + 8}px; cursor: pointer; border-radius: 4px; margin-bottom: 2px; transition: background 0.2s;" 
                         onclick="selectAccount(${node.id})"
                         onmouseover="this.style.background='#333'" 
                         onmouseout="this.style.background='transparent'"
                         data-account-id="${node.id}">
                        <span style="color: ${hasChildren ? '#D4AF37' : '#808080'}; margin-right: 6px;">${hasChildren ? '&#9660;' : '&#9679;'}</span>
                        <span style="color: #FFFFFF; font-size: 13px;">${node.name}</span>
                        <span style="color: #666; font-size: 11px; margin-left: 8px;">(${node.billing_plan || 'basic'})</span>
                    </div>
                `;
                
                if (hasChildren) {
                    node.children.forEach(child => {
                        html += renderNode(child, level + 1);
                    });
                }
                
                return html;
            };

            let html = '';
            accountsData.tree.forEach(node => {
                html += renderNode(node);
            });
            
            container.innerHTML = html;
        }

        // Select account and show details
        async function selectAccount(accountId) {
            currentAccountId = accountId;
            
            // Highlight selected node
            document.querySelectorAll('.account-node').forEach(node => {
                node.style.background = node.dataset.accountId == accountId ? '#404040' : 'transparent';
            });

            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load account');
                
                const account = await response.json();
                renderAccountDetails(account);
            } catch (error) {
                console.error('Load account details error:', error);
            }
        }

        // Render account details panel
        function renderAccountDetails(account) {
            const container = document.getElementById('accountDetailsContent');
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <div>
                        <h3 style="color: #D4AF37; font-size: 20px; margin-bottom: 6px;">${account.name}</h3>
                        <p style="color: #666; font-size: 13px;">${account.description || 'No description'}</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openEditAccountModal(${account.id})" style="background: #D4AF37; color: #1a1a1a; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Edit</button>
                        <button onclick="deleteAccount(${account.id})" style="background: #FF6B6B; color: #FFFFFF; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Delete</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
                    <div style="background: #1a1a1a; border-radius: 6px; padding: 12px;">
                        <p style="color: #666; font-size: 11px;">Billing Plan</p>
                        <p style="color: #D4AF37; font-size: 14px; font-weight: 600; text-transform: capitalize;">${account.billing_plan || 'Basic'}</p>
                    </div>
                    <div style="background: #1a1a1a; border-radius: 6px; padding: 12px;">
                        <p style="color: #666; font-size: 11px;">Users</p>
                        <p style="color: #4CAF50; font-size: 14px; font-weight: 600;">${(account.users || []).length}</p>
                    </div>
                    <div style="background: #1a1a1a; border-radius: 6px; padding: 12px;">
                        <p style="color: #666; font-size: 11px;">Channels</p>
                        <p style="color: #8B5CF6; font-size: 14px; font-weight: 600;">${(account.channels || []).length}</p>
                    </div>
                </div>

                <!-- Users Section -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #FFFFFF; font-size: 14px;">Assigned Users</h4>
                        <button onclick="openAssignUsersModal(${account.id}, '${account.name}')" style="background: transparent; border: 1px solid #D4AF37; color: #D4AF37; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Assign Users</button>
                    </div>
                    <div style="background: #1a1a1a; border-radius: 6px; padding: 12px; max-height: 200px; overflow-y: auto;">
                        ${(account.users || []).length > 0 
                            ? account.users.map(user => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333;">
                                    <div>
                                        <span style="color: #FFFFFF; font-size: 13px;">${user.username || user.email}</span>
                                        <span style="color: #666; font-size: 11px; margin-left: 8px;">${user.billing_plan || 'basic'}</span>
                                    </div>
                                    <button onclick="removeUserFromAccount(${account.id}, '${user.id}')" style="background: transparent; border: none; color: #FF6B6B; cursor: pointer; font-size: 18px;" title="Remove user">&times;</button>
                                </div>
                            `).join('')
                            : '<p style="color: #666; text-align: center; padding: 12px;">No users assigned</p>'
                        }
                    </div>
                </div>

                <!-- Channels Section -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #FFFFFF; font-size: 14px;">Assigned Channels</h4>
                        <button onclick="openAssignChannelsModal(${account.id}, '${account.name}')" style="background: transparent; border: 1px solid #8B5CF6; color: #8B5CF6; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Assign Channels</button>
                    </div>
                    <div style="background: #1a1a1a; border-radius: 6px; padding: 12px; max-height: 200px; overflow-y: auto;">
                        ${(account.channels || []).length > 0 
                            ? account.channels.map(ch => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333;">
                                    <div>
                                        <span style="color: #FFFFFF; font-size: 13px;">${ch.channel_id}</span>
                                        <span style="color: #4CAF50; font-size: 11px; margin-left: 8px;">${ch.access_level || 'read_write'}</span>
                                    </div>
                                    <button onclick="removeChannelFromAccount(${account.id}, '${ch.channel_id}')" style="background: transparent; border: none; color: #FF6B6B; cursor: pointer; font-size: 18px;" title="Remove channel">&times;</button>
                                </div>
                            `).join('')
                            : '<p style="color: #666; text-align: center; padding: 12px;">No channels assigned</p>'
                        }
                    </div>
                </div>

                <!-- Child Accounts -->
                ${(account.childAccounts || []).length > 0 ? `
                    <div>
                        <h4 style="color: #FFFFFF; font-size: 14px; margin-bottom: 12px;">Sub-Accounts</h4>
                        <div style="background: #1a1a1a; border-radius: 6px; padding: 12px;">
                            ${account.childAccounts.map(child => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #333; cursor: pointer;" onclick="selectAccount(${child.id})">
                                    <span style="color: #D4AF37; margin-right: 6px;">&#8627;</span>
                                    <span style="color: #FFFFFF; font-size: 13px;">${child.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Update account statistics
        function updateAccountStats() {
            const accounts = accountsData.accounts || [];
            const topLevel = accounts.filter(a => !a.parent_account_id);
            const subAccounts = accounts.filter(a => a.parent_account_id);
            
            document.getElementById('totalAccountsCount').textContent = accounts.length;
            document.getElementById('topLevelAccountsCount').textContent = topLevel.length;
            document.getElementById('subAccountsCount').textContent = subAccounts.length;
            
            // Count assigned users (would need to fetch from API for accuracy)
            document.getElementById('assignedUsersCount').textContent = '-';
        }

        // Open add account modal
        function openAddAccountModal() {
            currentAccountId = null;
            document.getElementById('accountModalTitle').textContent = 'Add Account';
            document.getElementById('accountName').value = '';
            document.getElementById('accountDescription').value = '';
            document.getElementById('accountBillingPlan').value = 'basic';
            document.getElementById('saveAccountBtn').textContent = 'Create Account';
            
            // Populate parent account dropdown
            const parentSelect = document.getElementById('accountParent');
            parentSelect.innerHTML = '<option value="">None (Top-Level Account)</option>';
            (accountsData.accounts || []).forEach(account => {
                parentSelect.innerHTML += `<option value="${account.id}">${account.name}</option>`;
            });
            
            document.getElementById('accountModal').classList.add('active');
        }

        // Open edit account modal
        async function openEditAccountModal(accountId) {
            currentAccountId = accountId;
            
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load account');
                
                const account = await response.json();
                
                document.getElementById('accountModalTitle').textContent = 'Edit Account';
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountDescription').value = account.description || '';
                document.getElementById('accountBillingPlan').value = account.billing_plan || 'basic';
                document.getElementById('saveAccountBtn').textContent = 'Save Changes';
                
                // Populate parent account dropdown (excluding self and descendants)
                const parentSelect = document.getElementById('accountParent');
                parentSelect.innerHTML = '<option value="">None (Top-Level Account)</option>';
                (accountsData.accounts || []).filter(a => a.id !== accountId).forEach(a => {
                    parentSelect.innerHTML += `<option value="${a.id}" ${a.id === account.parent_account_id ? 'selected' : ''}>${a.name}</option>`;
                });
                
                document.getElementById('accountModal').classList.add('active');
            } catch (error) {
                console.error('Load account error:', error);
                alert('Failed to load account');
            }
        }

        // Close account modal
        function closeAccountModal() {
            document.getElementById('accountModal').classList.remove('active');
            currentAccountId = null;
        }

        // Save account (create or update)
        async function saveAccount() {
            const name = document.getElementById('accountName').value;
            const description = document.getElementById('accountDescription').value;
            const parentId = document.getElementById('accountParent').value;
            const billingPlan = document.getElementById('accountBillingPlan').value;

            if (!name) {
                alert('Account name is required');
                return;
            }

            try {
                const url = currentAccountId ? `/api/accounts/${currentAccountId}` : '/api/accounts';
                const method = currentAccountId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        parent_account_id: parentId ? parseInt(parentId) : null,
                        billing_plan: billingPlan
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save account');
                }

                closeAccountModal();
                loadAccounts();
                alert(currentAccountId ? 'Account updated successfully' : 'Account created successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Delete account
        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account? This will remove all user and channel assignments.')) {
                return;
            }

            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete account');
                }

                loadAccounts();
                document.getElementById('accountDetailsContent').innerHTML = `
                    <p style="color: #666; text-align: center; padding: 40px 0;">Select an account from the tree to view details</p>
                `;
                alert('Account deleted successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Open assign users modal
        async function openAssignUsersModal(accountId, accountName) {
            selectedAccountForUsers = accountId;
            document.getElementById('assignUsersAccountName').textContent = accountName;
            
            try {
                const response = await fetch('/api/users/available', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const users = await response.json();
                const container = document.getElementById('assignUsersContainer');
                
                if (users.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No users available</p>';
                } else {
                    container.innerHTML = users.map(user => `
                        <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333;">
                            <input type="checkbox" id="user-${user.id}" value="${user.id}" style="margin-right: 12px; width: 18px; height: 18px;">
                            <label for="user-${user.id}" style="color: #FFFFFF; font-size: 13px; cursor: pointer; flex: 1;">
                                ${user.username || user.email}
                                <span style="color: #666; font-size: 11px; margin-left: 8px;">${user.email}</span>
                            </label>
                        </div>
                    `).join('');
                }
                
                document.getElementById('assignUsersModal').classList.add('active');
            } catch (error) {
                console.error('Load users error:', error);
                alert('Failed to load users');
            }
        }

        // Close assign users modal
        function closeAssignUsersModal() {
            document.getElementById('assignUsersModal').classList.remove('active');
            selectedAccountForUsers = null;
        }

        // Save assigned users
        async function saveAssignedUsers() {
            const checkboxes = document.querySelectorAll('#assignUsersContainer input[type="checkbox"]:checked');
            const userIds = Array.from(checkboxes).map(cb => cb.value);

            if (userIds.length === 0) {
                alert('Please select at least one user');
                return;
            }

            try {
                const response = await fetch(`/api/accounts/${selectedAccountForUsers}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ userIds })
                });

                if (!response.ok) throw new Error('Failed to assign users');

                closeAssignUsersModal();
                selectAccount(selectedAccountForUsers);
                alert('Users assigned successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Remove user from account
        async function removeUserFromAccount(accountId, userId) {
            if (!confirm('Remove this user from the account?')) return;

            try {
                const response = await fetch(`/api/accounts/${accountId}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to remove user');

                selectAccount(accountId);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Open assign channels modal
        async function openAssignChannelsModal(accountId, accountName) {
            selectedAccountForChannels = accountId;
            document.getElementById('assignChannelsAccountName').textContent = accountName;
            
            try {
                const response = await fetch('/api/channels', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load channels');
                
                const channels = await response.json();
                const container = document.getElementById('assignChannelsContainer');
                
                if (channels.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No channels available. Create groups first.</p>';
                } else {
                    container.innerHTML = channels.map(ch => `
                        <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333;">
                            <input type="checkbox" id="channel-${ch.id}" value="${ch.id}" style="margin-right: 12px; width: 18px; height: 18px;">
                            <label for="channel-${ch.id}" style="color: #FFFFFF; font-size: 13px; cursor: pointer; flex: 1;">
                                ${ch.name}
                                <span style="color: ${ch.type === 'emergency' ? '#FF6B6B' : '#4CAF50'}; font-size: 11px; margin-left: 8px;">${ch.type}</span>
                            </label>
                        </div>
                    `).join('');
                }
                
                document.getElementById('assignChannelsModal').classList.add('active');
            } catch (error) {
                console.error('Load channels error:', error);
                alert('Failed to load channels');
            }
        }

        // Close assign channels modal
        function closeAssignChannelsModal() {
            document.getElementById('assignChannelsModal').classList.remove('active');
            selectedAccountForChannels = null;
        }

        // Save assigned channels
        async function saveAssignedChannels() {
            const checkboxes = document.querySelectorAll('#assignChannelsContainer input[type="checkbox"]:checked');
            const channelIds = Array.from(checkboxes).map(cb => cb.value);
            const accessLevel = document.getElementById('channelAccessLevel').value;

            if (channelIds.length === 0) {
                alert('Please select at least one channel');
                return;
            }

            try {
                const response = await fetch(`/api/accounts/${selectedAccountForChannels}/channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ channelIds, accessLevel })
                });

                if (!response.ok) throw new Error('Failed to assign channels');

                closeAssignChannelsModal();
                selectAccount(selectedAccountForChannels);
                alert('Channels assigned successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Remove channel from account
        async function removeChannelFromAccount(accountId, channelId) {
            if (!confirm('Remove this channel from the account?')) return;

            try {
                const response = await fetch(`/api/accounts/${accountId}/channels/${encodeURIComponent(channelId)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to remove channel');

                selectAccount(accountId);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Filter accounts in tree
        function filterAccounts() {
            const searchTerm = document.getElementById('accountSearchBox').value.toLowerCase();
            const nodes = document.querySelectorAll('.account-node');
            
            nodes.forEach(node => {
                const text = node.textContent.toLowerCase();
                node.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Load accounts when accounts section is shown
        const originalSwitchSection = switchSection;
        switchSection = function(sectionId) {
            originalSwitchSection(sectionId);
            if (sectionId === 'accounts') {
                loadAccounts();
            }
        };
    </script>
</body>
</html>
