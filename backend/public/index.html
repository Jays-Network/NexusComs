<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>World Risk - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="/world-risk-logo.png">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <img src="/world-risk-logo.png" alt="World Risk Logo">
                </div>
                <h1>World Risk</h1>
                <p>Admin Dashboard</p>
            </div>
            
            <div class="error-message" id="loginError"></div>
            
            <form id="loginForm">
                <div id="step1">
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required placeholder="admin@example.com">
                    </div>
                    <button type="button" id="sendCodeBtn" onclick="sendVerificationCode()">Send Code</button>
                </div>

                <div id="step2" style="display: none;">
                    <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 16px;">
                        A verification code has been sent to your email. It expires in 10 minutes.
                    </p>
                    <div class="form-group">
                        <label for="code">Verification Code</label>
                        <input type="text" id="code" placeholder="000000" maxlength="6" inputmode="numeric" required>
                    </div>
                    <button type="button" id="verifyCodeBtn" onclick="verifyCode()">Verify & Sign In</button>
                    <button type="button" style="background: #404040; color: #FFFFFF; margin-top: 8px;" onclick="goBackToEmail()">Back</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div class="header-logo">
                <img src="/world-risk-logo.png" alt="World Risk Logo">
                <h1>World Risk Admin</h1>
            </div>
            <div class="user-info">
                <span id="currentUser"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="dashboard-wrapper">
            <!-- SIDEBAR NAVIGATION -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>Management</h3>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-item active" onclick="switchSection('dashboard-section')">Dashboard</div>
                    <div class="nav-item" onclick="switchSection('logs-section')">Logs</div>
                    <div class="nav-item" onclick="switchSection('users')">Users</div>
                    <div class="nav-item" onclick="switchSection('billing-plans')">Billing Plans</div>
                    <div class="nav-item" onclick="switchSection('accounts')">Accounts</div>
                    <div class="nav-item" onclick="switchSection('groups')">Groups & Subgroups</div>
                    <div class="nav-item" onclick="switchSection('emergency-groups')">Emergency Groups</div>
                    <div class="nav-item" onclick="switchSection('tracking')">Tracking</div>
                    <div class="nav-item" onclick="switchSection('security'); loadSecurityDashboard();">Security</div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- Sections loaded dynamically -->
                <div id="dashboard-section" class="section active"></div>
                <div id="logs-section" class="section"></div>
                <div id="users" class="section"></div>
                <div id="billing-plans" class="section"></div>
                <div id="accounts" class="section"></div>
                <div id="groups" class="section"></div>
                <div id="emergency-groups" class="section"></div>
                <div id="tracking" class="section"></div>
                <div id="security" class="section"></div>
            </div>
        </div>
    </div>

    <!-- Modals loaded dynamically -->
    <div id="modals-container"></div>

    <!-- Load section content -->
    <script>
        // Load HTML partial into a container
        async function loadPartial(url, containerId) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to load ${url}`);
                const html = await response.text();
                document.getElementById(containerId).innerHTML = html;
            } catch (error) {
                console.error(`Error loading partial ${url}:`, error);
                document.getElementById(containerId).innerHTML = `<div class="section-content"><p style="color: #FF6B6B;">Failed to load content. Please refresh the page.</p></div>`;
            }
        }

        // Load all sections on page load
        async function loadAllSections() {
            const sections = [
                { url: '/sections/dashboard.html', id: 'dashboard-section' },
                { url: '/sections/logs.html', id: 'logs-section' },
                { url: '/sections/users.html', id: 'users' },
                { url: '/sections/billing.html', id: 'billing-plans' },
                { url: '/sections/accounts.html', id: 'accounts' },
                { url: '/sections/groups.html', id: 'groups' },
                { url: '/sections/emergency-groups.html', id: 'emergency-groups' },
                { url: '/sections/tracking.html', id: 'tracking' },
                { url: '/sections/security.html', id: 'security' }
            ];

            const modals = [
                '/modals/service-modal.html',
                '/modals/forgot-password.html',
                '/modals/add-group.html',
                '/modals/add-emergency-group.html',
                '/modals/edit-user.html',
                '/modals/account-modal.html',
                '/modals/assign-users.html',
                '/modals/assign-channels.html',
                '/modals/edit-group.html'
            ];

            // Load all sections in parallel
            await Promise.all(sections.map(s => loadPartial(s.url, s.id)));

            // Load all modals into container
            const modalsContainer = document.getElementById('modals-container');
            const modalPromises = modals.map(async (url) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Failed to load ${url}`);
                    return await response.text();
                } catch (error) {
                    console.error(`Error loading modal ${url}:`, error);
                    return '';
                }
            });

            const modalContents = await Promise.all(modalPromises);
            modalsContainer.innerHTML = modalContents.join('\n');

            // Initialize app after content is loaded
            if (typeof initializeApp === 'function') {
                initializeApp();
            }
        }

        // Load sections when DOM is ready
        document.addEventListener('DOMContentLoaded', loadAllSections);
    </script>

    <!-- Main application JavaScript -->
    <script src="/js/app.js"></script>
</body>
</html>
